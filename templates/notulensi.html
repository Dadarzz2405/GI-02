{% extends "base.html" %}
{% block title %}{{ 'Edit' if note else 'Create' }} Notulensi — {{ session.name }} — Rohis{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow p-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h3 class="fw-bold mb-2">
                    <i class="fas fa-{{ 'edit' if note else 'plus-circle' }} text-primary me-2"></i>
                    {{ 'Edit' if note else 'Create' }} Notulensi
                </h3>
                <p class="text-muted mb-0">
                    <strong>{{ session.name }}</strong> — {{ session.date }}
                </p>
            </div>
            <a href="{{ url_for('notulensi_list') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to List
            </a>
        </div>

        {% if not can_edit %}
        <div class="alert alert-danger">
            <i class="fas fa-lock me-2"></i>
            <strong>Access Denied:</strong> You don't have permission to edit notulensi.
        </div>
        {% else %}

        <div id="editor" style="min-height: 400px; background: white;">
            {{ note.content|safe if note else "" }}
        </div>

        <div class="d-flex justify-content-between align-items-center mt-3">
            <div id="saveStatus" class="text-muted small"></div>
            <button id="saveBtn" class="btn btn-success">
                <i class="fas fa-save me-2"></i>Save Notulensi
            </button>
        </div>
        {% endif %}
    </div>
</div>

<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
const quill = new Quill('#editor', {
    theme: 'snow',
    modules: {
        toolbar: [
            [{ 'header': [1, 2, 3, false] }],
            ['bold', 'italic', 'underline', 'strike'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            [{ 'indent': '-1'}, { 'indent': '+1' }],
            [{ 'color': [] }, { 'background': [] }],
            [{ 'align': [] }],
            ['link'],
            ['clean']
        ]
    },
    placeholder: 'Start writing the meeting minutes here...'
});

const saveBtn = document.getElementById("saveBtn");
const saveStatus = document.getElementById("saveStatus");

// Auto-save indicator
let hasUnsavedChanges = false;
quill.on('text-change', () => {
    hasUnsavedChanges = true;
    saveStatus.innerHTML = '<i class="fas fa-circle text-warning me-2"></i>Unsaved changes';
});

// Warn before leaving with unsaved changes
window.addEventListener('beforeunload', (e) => {
    if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = '';
    }
});

saveBtn.onclick = async () => {
    const content = quill.root.innerHTML;
    
    // Check if content is empty
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = content;
    const textContent = tempDiv.textContent || tempDiv.innerText || '';
    
    if (!textContent.trim()) {
        alert('Cannot save empty notulensi. Please write something first.');
        return;
    }
    
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
    saveStatus.innerHTML = '<i class="fas fa-spinner fa-spin text-primary me-2"></i>Saving...';

    try {
        const res = await fetch(
            "/api/notulensi/{{ session.id }}",
            {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ content })
            }
        );

        if (res.ok) {
            hasUnsavedChanges = false;
            saveBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Saved!';
            saveBtn.classList.remove('btn-success');
            saveBtn.classList.add('btn-success');
            saveStatus.innerHTML = '<i class="fas fa-check-circle text-success me-2"></i>All changes saved';
            
            setTimeout(() => {
                saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Notulensi';
                saveBtn.disabled = false;
            }, 2000);
        } else {
            const data = await res.json();
            alert(data.error || "Failed to save. Please try again.");
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Notulensi';
            saveStatus.innerHTML = '<i class="fas fa-exclamation-circle text-danger me-2"></i>Save failed';
        }
    } catch (error) {
        console.error('Error:', error);
        alert("Error saving. Please check your connection.");
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Notulensi';
        saveStatus.innerHTML = '<i class="fas fa-exclamation-circle text-danger me-2"></i>Connection error';
    }
};

// Keyboard shortcut: Ctrl+S or Cmd+S to save
document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        saveBtn.click();
    }
});
</script>

<style>
.ql-toolbar {
    background-color: #f8f9fa;
    border-radius: 8px 8px 0 0;
}

.ql-container {
    border-radius: 0 0 8px 8px;
    font-size: 1rem;
    font-family: 'Inter', sans-serif;
}

.ql-editor {
    min-height: 400px;
}

.ql-editor.ql-blank::before {
    color: #6c757d;
    font-style: italic;
}
</style>
{% endblock %}